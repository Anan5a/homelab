version: "3.7"

services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    # container_name: gitlab
    restart: unless-stopped
    hostname: "gitlab.lab.sayem.pro"
    volumes:
      - ./config:/etc/gitlab
      - ./logs:/var/log/gitlab
      - ./data:/var/opt/gitlab

    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Set the external URL to HTTPS, Traefik handles the termination
        external_url 'https://gitlab.lab.sayem.pro' 

        # Configure the SSH host and port GitLab should display for clone URLs
        gitlab_rails['gitlab_ssh_host'] = 'gitlab.lab.sayem.pro'
        # This MUST match the port Traefik is listening on externally (2244)
        gitlab_rails['gitlab_shell_ssh_port'] = 2244 

        # Tell GitLab's internal NGINX that it's behind a proxy
        nginx['listen_https'] = false
        nginx['listen_port'] = 80

        # Recommended homelab optimizations (reduce memory footprint)
        puma['worker_processes'] = 2
        sidekiq['concurrency'] = 10

    # --- Traefik Labels (HTTP/S) ---
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=Host(`gitlab.lab.sayem.pro`)"
      - "traefik.http.routers.gitlab.entrypoints=websecure" # Assuming HTTPS entrypoint in Traefik
      - "traefik.http.routers.gitlab.tls=true"
      - "traefik.http.routers.gitlab.tls.certresolver=cf-letsencrypt"
      - "traefik.http.services.gitlab.loadbalancer.server.port=80" # GitLab's internal HTTP port
      - "traefik.tcp.routers.gitlab-ssh.rule=HostSNI(`*`)" # HostSNI must be '*' for generic SSH
      - "traefik.tcp.routers.gitlab-ssh.entrypoints=ssh" # Matches the 'ssh' EntryPoint on port 2244
      - "traefik.tcp.routers.gitlab-ssh.service=gitlab-ssh"
      - "traefik.tcp.services.gitlab-ssh.loadbalancer.server.port=22" # GitLab's internal SSH port

    # --- Networking ---
    networks:
      - homelab-net # Traefik and GitLab MUST share this network
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    # container_name: gitlab-runner
    restart: always
    
    # 1. CRITICAL: Mount the host's Docker socket for the Docker executor.
    # This allows the runner inside the container to spin up sibling containers for jobs.
    volumes:
      - ./runner-config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock:ro 
      
    # 2. Network: Must be on the same network as the GitLab service
    networks:
      - homelab-net
      
    # 3. CRITICAL: Automatic Registration (requires a Token from GitLab UI)
    environment:
      # The GitLab URL the Runner connects to (use the internal container name if not using the full external URL)
      # Since it's on a shared network, we can use the container name 'gitlab'
      RUNNER_EXECUTOR: docker
      CI_SERVER_URL: http://gitlab # Use the service name (container name) to connect internally
      REGISTRATION_TOKEN: 'glrt-oVtSFdmbBCw1SeF1FiR-X286MQpwOjEKdDozCnU6eg8.01.171uk4kez'
      RUNNER_NAME: docker-runner
      RUNNER_TAGS: 'docker, self-hosted'
      
      # # Configuration for the Docker Executor
      # DOCKER_IMAGE: "docker:latest"
      # DOCKER_PRIVILEGED: "true" # Required if you plan to build Docker images (Docker-in-Docker)
      # DOCKER_NETWORK_MODE: [] # Connects job containers to the same network