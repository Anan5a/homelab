version: "3.7"

services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    # container_name: gitlab
    restart: unless-stopped
    hostname: "gitlab.sayem.pro"

    # 2. Ports: Only publish the SSH port *internally* if necessary,
    # but we rely on Traefik for both SSH and HTTP/S.
    # NOTE: We only publish the SSH port (22) to the host for Traefik's TCP router.
    # We DO NOT publish 80/443 here.
    # We must not use ports: section for HTTP/S when using Traefik
    # We will publish 22:22 internally for the Traefik TCP router.

    # --- Persistent Volumes ---
    volumes:
      - ./config:/etc/gitlab
      - ./logs:/var/log/gitlab
      - ./data:/var/opt/gitlab

    # --- Environment & Configuration ---
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Set the external URL to HTTPS, Traefik handles the termination
        external_url 'https://gitlab.sayem.pro' 

        # Configure the SSH host and port GitLab should display for clone URLs
        gitlab_rails['gitlab_ssh_host'] = 'gitlab.sayem.pro'
        # This MUST match the port Traefik is listening on externally (2244)
        gitlab_rails['gitlab_shell_ssh_port'] = 2244 

        # Tell GitLab's internal NGINX that it's behind a proxy
        nginx['listen_https'] = false
        nginx['listen_port'] = 80

        # Recommended homelab optimizations (reduce memory footprint)
        puma['worker_processes'] = 2
        sidekiq['concurrency'] = 10

    # --- Traefik Labels (HTTP/S) ---
    labels:
      - "traefik.enable=true"

      # HTTP/S Router (Web access)
      - "traefik.http.routers.gitlab.rule=Host(`gitlab.sayem.pro`)"
      - "traefik.http.routers.gitlab.entrypoints=websecure" # Assuming HTTPS entrypoint in Traefik
      - "traefik.http.routers.gitlab.tls=true"
      # Assuming you have a certificate resolver defined in Traefik (e.g., 'le' for Let's Encrypt)
      # - "traefik.http.routers.gitlab.tls.certresolver=le"
      - "traefik.http.services.gitlab.loadbalancer.server.port=80" # GitLab's internal HTTP port

      # --- Traefik Labels (SSH/TCP) ---
      # SSH requires a TCP router and a matching entrypoint in Traefik
      - "traefik.tcp.routers.gitlab-ssh.rule=HostSNI(`*`)" # HostSNI must be '*' for generic SSH
      - "traefik.tcp.routers.gitlab-ssh.entrypoints=ssh" # Matches the 'ssh' EntryPoint on port 2244
      - "traefik.tcp.routers.gitlab-ssh.service=gitlab-ssh"
      - "traefik.tcp.services.gitlab-ssh.loadbalancer.server.port=22" # GitLab's internal SSH port

    # --- Networking ---
    networks:
      - homelab-net # Traefik and GitLab MUST share this network
